<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:db="http://www.mulesoft.org/schema/mule/db" xmlns:validation="http://www.mulesoft.org/schema/mule/validation"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/validation http://www.mulesoft.org/schema/mule/validation/current/mule-validation.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd">
	<http:request-config name="cca-connection-HTTP_Request_configuration" doc:name="HTTP Request configuration" doc:id="2ecfd3e5-1f8e-4bae-bc9e-e17e7a4a23b6" responseTimeout="${http.request.cca.api.timeout}">
		<http:request-connection protocol="HTTPS" host="${http.request.cca.api.host}" port="#[vars.port]"/>
	</http:request-config>
	<sub-flow name="client-cca-call-services-get-order-remision" doc:id="ec19fe54-08e9-4fea-8454-6cc2ec8082e3" >
		<logger level="INFO" doc:name="Logger" doc:id="1d2450f6-d3b6-48f8-b9cb-31517a47a88e" message="#[payload]"/>
		<try doc:name="Try" doc:id="1dfdd28d-f0ff-410d-bcac-76e12ee437d2" >
			<http:request method="GET" doc:name="Request" doc:id="d313d774-6ace-49b5-b99d-7f2c3e4cc4dd" url="https://ppsai-abasto.imss.gob.mx/msportprov-orden/v1/ordenes/{orden}">
			<http:uri-params><![CDATA[#[output application/java
---
{
	"orden" : vars.orden
}]]]></http:uri-params>
			<http:query-params><![CDATA[#[output application/java
---
{
	"clasPtal" : vars.clasPtal,
	"contrato" : vars.contrato,
	"password" : vars.password
}]]]></http:query-params>
		</http:request>
			<error-handler >
				<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="8254d1b5-f724-49df-b217-76e30d419efe" >
					<ee:transform doc:name="Transform Message" doc:id="ac92ff4a-6f22-417e-bcf7-8c0e96ec91c5" >
						<ee:message >
						</ee:message>
						<ee:variables >
							<ee:set-variable variableName="errorCode" ><![CDATA[%dw 2.0
output application/json
---
error.errorMessage.payload.code]]></ee:set-variable>
							<ee:set-variable variableName="errorMessage" ><![CDATA[%dw 2.0
output application/json
---
write(error.errorMessage.payload,"application/json")]]></ee:set-variable>
						</ee:variables>
					</ee:transform>
					<validation:is-false doc:name="Is false" doc:id="0517bea4-463d-4e40-babf-8a2a3fd6bfac" expression='#[vars.errorCode == "409"]' message="#[vars.errorMessage]">
						<error-mapping sourceType="VALIDATION:INVALID_BOOLEAN" targetType="CCA:BAD_REQUEST" />
					</validation:is-false>
				</on-error-continue>
			</error-handler>
		</try>
		<logger level="INFO" doc:name="Logger" doc:id="82a98730-5fe0-4c9a-920f-c7bf519d506c" message="#[payload]" />
		<ee:transform doc:name="prepare response" doc:id="3a1027f9-159a-464c-b3a8-39c22ef6331c">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
fun validateStatus(estatusOrden) =
estatusOrden match {
  case "0" -> { "estatusDescription": "GENERADA/A. PARCIAL"}
  case "1" -> { "estatusDescription": "INCUMPLIDA"}
  case "2" -> { "estatusDescription": "ATENDIDA ( TOTAL )"}
  case "4" -> { "estatusDescription": "CANCELADA"}
  else -> { "estatusDescription": "NO DISPONIBLE"}
}
---
payload ++ validateStatus(payload.estatusOrden)]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</sub-flow>
	<sub-flow name="client-cca-call-services-get-order-confirmation" doc:id="93809432-409f-4b12-b995-26a263a938a4" >
		<logger level="INFO" doc:name="Logger" doc:id="fced381f-8cb9-47ba-9ad5-337179b99590" message="#[payload]"/>
		<http:request method="POST" doc:name="Request" doc:id="8cc5325d-88e3-4bbf-870c-1de232e2d6ac" url="https://ppsai-abasto.imss.gob.mx/msportprov-entrada/v1/entradas">
		</http:request>
		<logger level="INFO" doc:name="Logger" doc:id="142d806b-46a3-4c03-8ff6-e65eaf084b15" message="#[payload]"/>
	</sub-flow>
	<sub-flow name="client-cca-call-services-validation-206" doc:id="ebc220e6-61ce-4ede-b316-f873cdf590fc" >
 <ee:transform doc:name="Catch http status 206" doc:id="025b9a2f-59ba-486c-bc65-977a8998be3d">
                <ee:message>
                </ee:message>
                <ee:variables>
				<ee:set-variable variableName="codeErrorCca" ><![CDATA[attributes.statusCode]]></ee:set-variable>
                </ee:variables>
            </ee:transform>
        <validation:is-false doc:name="Is false" doc:id="915a2e37-0562-42eb-bc2f-8c039a2268ab" expression='#[(vars.codeErrorCca as Number == 206) and (payload[0].resultado.estado != "Alta OK.")]' message='#[write(flatten(payload.erroresM ++ payload.erroresD),"application/json")]'>
			<error-mapping sourceType="VALIDATION:INVALID_BOOLEAN" targetType="CCA:BAD_REQUEST" />
		</validation:is-false>
		<logger level="INFO" doc:name="Logger" doc:id="b0a9fc5c-af14-4524-b80e-c1f605a5af59" message="#[payload]"/>		
	</sub-flow>
</mule>
