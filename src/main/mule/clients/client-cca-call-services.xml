<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:db="http://www.mulesoft.org/schema/mule/db" xmlns:validation="http://www.mulesoft.org/schema/mule/validation"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/validation http://www.mulesoft.org/schema/mule/validation/current/mule-validation.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd">
	<sub-flow name="client-cca-call-services-get-order-remision" doc:id="ec19fe54-08e9-4fea-8454-6cc2ec8082e3" >
		<logger level="INFO" doc:name="Logger" doc:id="1d2450f6-d3b6-48f8-b9cb-31517a47a88e" message="#[payload]"/>
			<try doc:name="Try" doc:id="cca68d64-0533-4543-b725-c52921100323" >
			<until-successful maxRetries="5" doc:name="Until Successful" doc:id="1fcf1678-803b-4ba5-910e-0f0a966a806b" millisBetweenRetries="30000">
				<http:request method="GET" doc:name="Request" doc:id="fc6f1876-9dc1-4ecf-bbc8-0e47b7803e25" config-ref="Http_request_CCA" path="${https.request.cca.api.get.order.remision}">
			<http:headers><![CDATA[#[output application/java
---
{
	"Host" : p('https.request.cca.api.host')
}]]]></http:headers>
			<http:uri-params><![CDATA[#[output application/java
---
{
	"orden" : vars.orden
}]]]></http:uri-params>
			<http:query-params><![CDATA[#[output application/java
---
{
	"clasPtal" : vars.clasPtal,
	"contrato" : vars.contrato,
	"password" : vars.password
}]]]></http:query-params>
		</http:request>
			</until-successful>
			<error-handler >
				<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="8254d1b5-f724-49df-b217-76e30d419efe">
					<ee:transform doc:name="Transform Message" doc:id="ac92ff4a-6f22-417e-bcf7-8c0e96ec91c5">
						<ee:message>
						</ee:message>
						<ee:variables>
							<ee:set-variable variableName="errorCode"><![CDATA[%dw 2.0
output application/json
---
error.errorMessage.payload.code]]></ee:set-variable>
							<ee:set-variable variableName="errorMessage"><![CDATA[%dw 2.0
output application/json
---
write(error.errorMessage.payload,"application/json")]]></ee:set-variable>
						</ee:variables>
					</ee:transform>
					<validation:is-false doc:name="Is false" doc:id="0517bea4-463d-4e40-babf-8a2a3fd6bfac" expression='#[vars.errorCode == "409"]' message="#[vars.errorMessage]">
						<error-mapping sourceType="VALIDATION:INVALID_BOOLEAN" targetType="CCA:BAD_REQUEST" />
					</validation:is-false>
				</on-error-continue>
			</error-handler>
		</try>
		<logger level="INFO" doc:name="Logger" doc:id="82a98730-5fe0-4c9a-920f-c7bf519d506c" message="#[payload]" />
		<ee:transform doc:name="prepare response" doc:id="3a1027f9-159a-464c-b3a8-39c22ef6331c">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
fun validateStatus(estatusOrden) =
estatusOrden match {
  case "0" -> { "estatusDescription": "GENERADA/A. PARCIAL"}
  case "1" -> { "estatusDescription": "INCUMPLIDA"}
  case "2" -> { "estatusDescription": "ATENDIDA ( TOTAL )"}
  case "4" -> { "estatusDescription": "CANCELADA"}
  else -> { "estatusDescription": "NO DISPONIBLE"}
}
---
payload ++ validateStatus(payload.estatusOrden)]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</sub-flow>
	<sub-flow name="client-cca-call-services-get-order-remision-bienestar" doc:id="b79be803-f372-4b15-a094-3469394b2a43" >
		<logger level="INFO" doc:name="Logger" doc:id="32851433-eaa8-4952-9f4c-b217781147fe" message="#[payload]"/>
		<try doc:name="Try" doc:id="00c26735-4575-4609-8325-c3c976922b08" >
			<until-successful maxRetries="5" doc:name="Until Successful" doc:id="ef5ba55f-711d-4d5b-a7c6-3f2a6bb0c0b7" millisBetweenRetries="30000">
				<http:request method="GET" doc:name="Request" doc:id="3f71df19-978a-47e3-8307-a73548a04448" config-ref="Http_request_CCA_Bienestar" path="${https.request.cca.bienestar.api.get.order.remision}">
			<http:headers><![CDATA[#[output application/java
---
{
	"Host" : p('https.request.cca.bienestar.api.host')
}]]]></http:headers>
			<http:uri-params><![CDATA[#[output application/java
---
{
	"orden" : vars.orden
}]]]></http:uri-params>
			<http:query-params><![CDATA[#[output application/java
---
{
	"clasPtal" : vars.clasPtal,
	"contrato" : vars.contrato,
	"password" : vars.password
}]]]></http:query-params>
		</http:request>
			</until-successful>
			<error-handler >
				<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="666ea41c-bcf8-4763-b8de-3d1408045ae6" >
					<ee:transform doc:name="Transform Message" doc:id="025bcbf2-de9a-4b73-a49f-4c2d5c571c0b" >
						<ee:message />
						<ee:variables >
							<ee:set-variable variableName="errorCode" ><![CDATA[%dw 2.0
output application/json
---
error.errorMessage.payload.code]]></ee:set-variable>
							<ee:set-variable variableName="errorMessage" ><![CDATA[%dw 2.0
output application/json
---
write(error.errorMessage.payload,"application/json")]]></ee:set-variable>
						</ee:variables>
					</ee:transform>
					<validation:is-false doc:name="Is false" doc:id="bce938ab-9bfa-4ddf-b187-748195bf15bb" expression='#[vars.errorCode == "409"]' message="#[vars.errorMessage]" >
						<error-mapping sourceType="VALIDATION:INVALID_BOOLEAN" targetType="CCA:BAD_REQUEST" />
					</validation:is-false>
				</on-error-continue>
			</error-handler>
		</try>
		<logger level="INFO" doc:name="Logger" doc:id="145d0464-1543-41b3-a9a4-cf1a841dfc0f" message="#[payload]"/>
	</sub-flow>
	<sub-flow name="client-cca-call-services-get-order-confirmation" doc:id="93809432-409f-4b12-b995-26a263a938a4" >
		<logger level="INFO" doc:name="Logger" doc:id="fced381f-8cb9-47ba-9ad5-337179b99590" message="#[payload]"/>
		<until-successful maxRetries="5" doc:name="Until Successful" doc:id="5955c611-8fa2-489b-8fe0-07132c6a5c99" millisBetweenRetries="30000">
			<http:request method="POST" doc:name="Request" doc:id="8cc5325d-88e3-4bbf-870c-1de232e2d6ac" config-ref="Http_request_CCA" path="${https.request.cca.api.post.create.remision}">
			<http:headers><![CDATA[#[output application/java
---
{
	"Host" : p('https.request.cca.api.host')
}]]]></http:headers>
		</http:request>
		</until-successful>
		<ee:transform doc:name="Catch http status 206" doc:id="6149e312-9df5-442a-8742-5c565e877b77">
				<ee:message>
				</ee:message>
				<ee:variables>
				<ee:set-variable variableName="codeErrorCca" ><![CDATA[attributes.statusCode]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
		<validation:is-false doc:name="Is false" doc:id="0dc049da-ed2f-416e-82b2-b2b60e51edc8" expression="#[(!isEmpty(payload[0].erroresM)) or (!isEmpty(payload[0].erroresD))]" message='#[write(flatten(payload.erroresM ++ payload.erroresD),"application/json")]' >
			<error-mapping sourceType="VALIDATION:INVALID_BOOLEAN" targetType="CCA:BAD_REQUEST" />
		</validation:is-false>
		<logger level="INFO" doc:name="Logger" doc:id="142d806b-46a3-4c03-8ff6-e65eaf084b15" message="#[payload]"/>
	</sub-flow>
	<sub-flow name="client-cca-call-services-get-order-confirmation-bienestar" doc:id="b9fa3fd7-65a2-4a2a-b9d2-2eaad2452500" >
		<logger level="INFO" doc:name="Logger" doc:id="fdd2a906-56e1-4344-a9b7-74f65352d347" message="#[payload]"/>
		<until-successful maxRetries="5" doc:name="Until Successful" doc:id="1ea75314-87f9-4fb6-b08d-c7f85e1e3ac9" millisBetweenRetries="30000">
			<http:request method="POST" doc:name="Request" doc:id="7a241a90-c547-4b74-9134-d3bb2750901b" config-ref="Http_request_CCA_Bienestar" path="${https.request.cca.bienestar.api.post.create.remision}">
			<http:headers><![CDATA[#[output application/java
---
{
	"Host" : p('https.request.cca.bienestar.api.host')
}]]]></http:headers>
		</http:request>
		</until-successful>
		<ee:transform doc:name="Catch http status 206" doc:id="d5ad94ff-605d-4938-bdde-27150c84e5c1">
				<ee:message>
				</ee:message>
				<ee:variables>
				<ee:set-variable variableName="codeErrorCca" ><![CDATA[attributes.statusCode]]></ee:set-variable>
                </ee:variables>
            </ee:transform>
        <validation:is-false doc:name="Is false" doc:id="915a2e37-0562-42eb-bc2f-8c039a2268ab" expression='#[(!isEmpty(payload[0].erroresM)) or (!isEmpty(payload[0].erroresD))]' message='#[write(flatten(payload.erroresM ++ payload.erroresD),"application/json")]'>
			<error-mapping sourceType="VALIDATION:INVALID_BOOLEAN" targetType="CCA:BAD_REQUEST" />
		</validation:is-false>
		<logger level="INFO" doc:name="Logger" doc:id="b0a9fc5c-af14-4524-b80e-c1f605a5af59" message="#[payload]"/>		

	</sub-flow>
</mule>
