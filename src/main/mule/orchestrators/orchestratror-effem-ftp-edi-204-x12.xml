<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ftp="http://www.mulesoft.org/schema/mule/ftp"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:x12="http://www.mulesoft.org/schema/mule/x12"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/x12 http://www.mulesoft.org/schema/mule/x12/current/mule-x12.xsd
http://www.mulesoft.org/schema/mule/ftp http://www.mulesoft.org/schema/mule/ftp/current/mule-ftp.xsd">
	<sub-flow name="orchestratror-effem-ftp-edi-204-x12-main" doc:id="9c049be4-6d0e-49b1-95c7-5d6cc07d4911" >
		<flow-ref doc:name="clients-ftp-obtain-files-effem" doc:id="cc30e99a-0a89-48dc-88ef-5f6e349a0a3e" name="clients-ftp-obtain-files-effem"/>
		<flow-ref doc:name="orchestratror-effem-ftp-edi-204-x12-validate-files" doc:id="82092f34-17e7-459c-9d16-566e585629a9" name="orchestratror-effem-ftp-edi-204-x12-validate-files"/>
	</sub-flow>
	<sub-flow name="orchestratror-effem-ftp-edi-204-x12-validate-files" doc:id="12ef57d9-4d52-459b-9ca6-bb64d94fe5c8" >
		<foreach doc:name="iterate list files" doc:id="228dee09-1b6a-45ac-8239-77dadbf5f15e" collection="#[payload]" >
			<choice doc:name="Choice" doc:id="47dc721d-a9df-4041-8bee-aece7a5dfd71" >
				<when expression="#[payload == null or payload == []]" >
					<logger level="INFO" doc:name="Logger" doc:id="cafa3543-2f78-42e4-9e60-1916aaea47b1" message="#['\n'] ********** NADA QUE PROCESAR ******* #['\n']" />
				</when>
				<otherwise>
					<set-variable value="#[attributes.fileName]" doc:name="Set Variable" doc:id="ff783f48-0942-4869-9713-535a1a94d563" variableName="nombre" />
					<logger level="INFO" doc:name="Logger" doc:id="d1333afe-cb91-4f32-9e3e-a7cc1d9e5696" message="processing file -&gt; #[vars.nombre]"/>
					<flow-ref doc:name="orchestratror-effem-ftp-edi-204-x12-validate-edi-type" doc:id="f8c9d5ef-bec3-453d-937a-b1ff9ea9a407" name="orchestratror-effem-ftp-edi-204-x12-validate-edi-type"/>
				
</otherwise>
			</choice>
		</foreach>	
	</sub-flow>
	<sub-flow name="orchestratror-effem-ftp-edi-204-x12-validate-edi-type" doc:id="c85b3d36-45c6-4ffa-8cd0-7f0e9b8449c8" >
		<choice doc:name="Choice" doc:id="180179c4-f99b-471a-8dcd-a0c5f159154e" >
			<when expression='#[(vars.nombre default "") contains("204")]'>
				<flow-ref doc:name="orchestratror-effem-ftp-edi-204-x12-read-edi" doc:id="62c7c20a-cb70-4af3-9f3c-4e3763d664e2" name="orchestratror-effem-ftp-edi-204-x12-read-edi" />
				<flow-ref doc:name="orchestratror-effem-ftp-edi-204-x12-validate-errors" doc:id="eef40771-ef2a-4362-9e71-7e3713f2c141" name="orchestratror-effem-ftp-edi-204-x12-validate-errors" />
			</when>
			<when expression='#[(vars.nombre default "") contains("214")]'>
				<logger level="INFO" doc:name="Logger" doc:id="804dfe69-4f6d-48c6-b3bc-c8ecd8380987" />
				<flow-ref doc:name="orchestratror-effem-ftp-edi-204-x12-read-edi" doc:id="90c4c0af-97cf-4244-a9e7-53adc6e27231" name="orchestratror-effem-ftp-edi-204-x12-read-edi"/>
			</when>
			<otherwise >
				<logger level="INFO" doc:name="Logger" doc:id="e0a40408-5d13-487a-adcd-62243e6117ed" message="EDI NOT PROCESS"/>
			</otherwise>
		</choice>
	</sub-flow>
	<sub-flow name="orchestratror-effem-ftp-edi-204-x12-read-edi" doc:id="0c4da49f-0790-42e5-a808-90426f0a3b80" >
		<x12:read doc:name="Read edi" doc:id="147c5e2d-2e0d-4148-8265-716fc7362a83" config-ref="X12_EDI_Config" />
		<logger level="INFO" doc:name="print payload" doc:id="1481fa9e-64fc-48e2-b663-ed8570014efa" message="#[%dw 2.0&#10;output application/json&#10;---&#10;payload]" />
	</sub-flow>
	<sub-flow name="orchestratror-effem-ftp-edi-204-x12-validate-errors" doc:id="4e5273bc-789a-446e-b629-0b81422b7fa9" >
		<choice doc:name="Choice" doc:id="4738c2f2-e55f-4623-8c8c-00f65ef2275c" >
			<when expression="#[isEmpty(payload.Errors)]">
				<flow-ref doc:name="orchestratror-effem-ftp-edi-204-x12-prepare-payload" doc:id="219ae9a0-bcd2-41a4-9496-c809312b6a38" name="orchestratror-effem-ftp-edi-204-x12-prepare-payload"/>
				<flow-ref doc:name="jms-publish-mesages-publish-edi-json" doc:id="5ce530ec-7ec7-46c9-b55e-fe0b7e62c3ce" name="jms-publish-mesages-publish-edi-json" />
				<flow-ref doc:name="orchestratror-effem-ftp-edi-204-x12-remove-file-ftp" doc:id="c9e2bb7e-b740-48a1-9752-01c53d925055" name="orchestratror-effem-ftp-edi-204-x12-remove-file-ftp"/>
			
</when>
			<otherwise >
				<logger level="ERROR" doc:name="Logger" doc:id="6b0d8be4-5ee1-4aae-a54b-c598819fd491" message="#[payload.Errors]" category="EDI ERRORS"/>
			</otherwise>
		
		</choice>
	</sub-flow>
	<sub-flow name="orchestratror-effem-ftp-edi-214-x12-validate-errors" doc:id="f828d4b6-4cec-42da-9b06-3b860ef186a8" >
		<choice doc:name="Choice" doc:id="ef8df540-9422-4337-b7b5-c525c12e10cc" >
			<when expression="#[isEmpty(payload.Errors)]">
				<flow-ref doc:name="orchestratror-effem-ftp-edi-214-x12-prepare-payload" doc:id="0bd45153-7ae0-42ce-9b54-f7cf8e0d0cd9" name="orchestratror-effem-ftp-edi-214-x12-prepare-payload"/>
				<flow-ref doc:name="jms-publish-mesages-publish-edi-json" doc:id="fe6b0134-37b1-4afb-8d10-cee161ac6219" name="jms-publish-mesages-publish-edi-json" />
			
</when>
			<otherwise >
				<logger level="ERROR" doc:name="Logger" doc:id="725ac221-b786-44e4-a625-225bc73cd805" message="#[payload.Errors]" category="EDI ERRORS"/>
			</otherwise>
		
		</choice>
	</sub-flow>	
	<sub-flow name="orchestratror-effem-ftp-edi-204-x12-prepare-payload" doc:id="718d5510-d44c-474a-a15d-adc4bb2dc6d4" >
		<ee:transform doc:name="Transform Message" doc:id="8b09dc8c-ecdc-40c8-8b32-ad008d8d8cb9" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload.TransactionSets.v004010."204"[0]]]></ee:set-payload>
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="status" ><![CDATA[%dw 2.0
output application/java
---
"tender"
]]></ee:set-variable>
				<ee:set-variable variableName="operation_name" ><![CDATA[%dw 2.0
output application/json
---
"Motor Carrier Load Tender"
]]></ee:set-variable>
				<ee:set-variable variableName="event" ><![CDATA[%dw 2.0
output application/json
---
"204"]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
	</sub-flow>
	<sub-flow name="orchestratror-effem-ftp-edi-204-x12-remove-file-ftp" doc:id="e58e3388-6b1f-4b44-ab7f-5a1e06d2190b" >
		<ftp:delete doc:name="Delete" doc:id="ce615f28-911e-4d55-bea5-fc2c31ff21db" config-ref="FTP_Config_effem" path="#[p('sftp.directory.path') ++&quot;/&quot; ++ vars.nombre]"/>
	</sub-flow>
	<sub-flow name="orchestratror-effem-ftp-edi-214-x12-prepare-payload" doc:id="858efb1c-01df-4b01-8a3e-2ba03189eacb" >
		<ee:transform doc:name="Transform Message" doc:id="b9e604af-a298-4f73-9f9f-85acb16928eb">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload.TransactionSets.v004010."214"[0]]]></ee:set-payload>
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="status"><![CDATA[%dw 2.0
output application/java
---
"shipment_status"
]]></ee:set-variable>
				<ee:set-variable variableName="operation_name"><![CDATA[%dw 2.0
output application/json
---
"Transportation Carrier Shipment Status Message"
]]></ee:set-variable>
				<ee:set-variable variableName="event"><![CDATA[%dw 2.0
output application/json
---
"214"]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
	</sub-flow>
</mule>
